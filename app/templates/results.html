{% extends "base.html" %}

{% block title %}Schools Near You - NSW School Finder{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="mb-6">
        <a href="/" class="text-black hover:underline font-hand mb-4 inline-block">← Back to search</a>
        <h1 class="text-3xl sm:text-4xl font-hand font-bold text-black mb-2">
            Schools Near You
        </h1>
        <p class="text-gray-700 font-sans">
            {% if suburb and postcode %}
                Found {{ result_count }} school{{ 's' if result_count != 1 else '' }} within {{ radius }}km of {{ suburb }}, {{ postcode }}
            {% elif suburb %}
                Found {{ result_count }} school{{ 's' if result_count != 1 else '' }} within {{ radius }}km of {{ suburb }}
            {% elif postcode %}
                Found {{ result_count }} school{{ 's' if result_count != 1 else '' }} within {{ radius }}km of postcode {{ postcode }}
            {% endif %}
        </p>
    </div>

    {% if not schools %}
    <div class="bg-gray-50 border-2 border-black rounded-lg p-8 text-center">
        <p class="text-lg text-gray-700 font-sans mb-4">No schools found matching your criteria.</p>
        <a href="/" class="inline-block bg-black text-white px-6 py-3 rounded-lg font-hand font-bold hover:bg-gray-800 transition-colors">Modify Search</a>
    </div>
    {% else %}
    <!-- Quick Filter -->
    <div class="bg-white border-2 border-black rounded-lg p-4 mb-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <form method="POST" action="/results" class="flex items-center gap-3 flex-1">
                <input type="hidden" name="suburb" value="{{ suburb or '' }}">
                <input type="hidden" name="postcode" value="{{ postcode or '' }}">
                <input type="hidden" name="radius" value="{{ radius }}">

                <label for="level" class="text-sm font-medium text-black font-sans whitespace-nowrap">
                    Filter by level:
                </label>
                <select
                    id="level"
                    name="level"
                    onchange="this.form.submit()"
                    class="flex-1 px-3 py-2 border-2 border-black rounded-lg focus:ring-2 focus:ring-black font-sans text-sm"
                >
                    <option value="">All Levels</option>
                    {% for level_option in distinct_levels %}
                    <option value="{{ level_option }}" {% if selected_level == level_option %}selected{% endif %}>
                        {{ level_option }}
                    </option>
                    {% endfor %}
                </select>
            </form>

            <a href="/" class="text-sm text-black hover:underline font-sans whitespace-nowrap">
                ← Modify search options
            </a>
        </div>

        <!-- Show active filters as badges -->
        {% if filters and (filters.has_preschool or filters.has_intensive_english or filters.has_opportunity_class or filters.not_selective or filters.has_distance_education) %}
        <div class="mt-3 pt-3 border-t border-gray-200">
            <p class="text-xs text-gray-700 font-sans mb-2">Active filters:</p>
            <div class="flex flex-wrap gap-2">
                {% if filters.has_preschool %}
                <span class="inline-block bg-black text-white text-xs px-2 py-1 rounded-full font-sans">Preschool on site</span>
                {% endif %}
                {% if filters.has_intensive_english %}
                <span class="inline-block bg-black text-white text-xs px-2 py-1 rounded-full font-sans">English language support</span>
                {% endif %}
                {% if filters.has_opportunity_class %}
                <span class="inline-block bg-black text-white text-xs px-2 py-1 rounded-full font-sans">Opportunity class</span>
                {% endif %}
                {% if filters.not_selective %}
                <span class="inline-block bg-black text-white text-xs px-2 py-1 rounded-full font-sans">Not selective</span>
                {% endif %}
                {% if filters.has_distance_education %}
                <span class="inline-block bg-black text-white text-xs px-2 py-1 rounded-full font-sans">Distance education</span>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Comparison form -->
    <form id="compareForm" method="GET" action="/compare">
        <div class="mb-4 flex items-center justify-between">
            <p class="text-sm text-gray-700 font-sans">Select up to 3 schools to compare</p>
            <button
                type="submit"
                id="compareBtn"
                class="bg-black text-white px-4 py-2 rounded-lg font-hand font-bold hover:bg-gray-800 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                disabled
            >
                Compare Selected
            </button>
        </div>

        <!-- School Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for school in schools %}
            <div class="bg-white border-2 border-black rounded-lg p-4 sm:p-6 hover:shadow-lg transition-shadow">
                <div class="flex items-start justify-between mb-3">
                    <input
                        type="checkbox"
                        name="ids"
                        value="{{ school.id }}"
                        data-distance="{{ school.distance }}"
                        class="compare-checkbox mt-1 w-5 h-5 border-2 border-black rounded focus:ring-2 focus:ring-black"
                        aria-label="Select {{ school.school_name }} for comparison"
                    >
                    <div class="flex items-center gap-2">
                        <button
                            type="button"
                            class="save-btn text-gray-400 hover:text-red-500 transition-colors"
                            data-school-id="{{ school.id }}"
                            data-school='{{ {"id": school.id, "school_name": school.school_name, "level_of_schooling": school.level_of_schooling, "street": school.street, "town_suburb": school.town_suburb, "postcode": school.postcode, "school_gender": school.school_gender, "latest_year_enrolment_fte": school.latest_year_enrolment_fte, "distance": school.distance, "opportunity_class": school.opportunity_class, "intensive_english_centre": school.intensive_english_centre}|tojson|e }}'
                            aria-label="Save {{ school.school_name }}"
                        >
                            <svg class="w-5 h-5 heart-outline" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                            </svg>
                            <svg class="w-5 h-5 heart-filled hidden" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                        </button>
                        <span class="text-sm font-sans text-gray-700">{{ school.distance }} km</span>
                    </div>
                </div>

                <h3 class="text-lg font-hand font-bold text-black mb-2">
                    {{ school.school_name or "Not available" }}
                </h3>

                <div class="space-y-1 mb-4 text-sm font-sans text-gray-700">
                    <p><strong>Level:</strong> {{ school.level_of_schooling or "Not available" }}</p>
                    <p><strong>Location:</strong> {{ school.street or "" }}{% if school.street and school.town_suburb %}, {% endif %}{{ school.town_suburb or "" }}{% if school.postcode %}, {{ school.postcode }}{% endif %}</p>
                    {% if school.latest_year_enrolment_fte %}
                    <p><strong>Enrolment:</strong> {{ "%.0f"|format(school.latest_year_enrolment_fte) }}</p>
                    {% else %}
                    <p><strong>Enrolment:</strong> Not available</p>
                    {% endif %}
                </div>

                <!-- Info Badges -->
                <div class="flex flex-wrap gap-2 mb-4">
                    <!-- Gender badge -->
                    {% if school.school_gender %}
                    <span class="inline-block bg-black text-white text-xs px-2 py-1 rounded-full font-sans">
                        {% if school.school_gender == "Coed" %}Boys & Girls{% else %}{{ school.school_gender }}{% endif %}
                    </span>
                    {% endif %}

                    <!-- Size badge -->
                    {% if school.latest_year_enrolment_fte %}
                    <span class="inline-block bg-black text-white text-xs px-2 py-1 rounded-full font-sans">
                        {% if school.latest_year_enrolment_fte < 300 %}Small{% elif school.latest_year_enrolment_fte <= 800 %}Medium{% else %}Large{% endif %}
                    </span>
                    {% endif %}

                    <!-- Advanced (OC) badge -->
                    {% if school.opportunity_class == "Y" %}
                    <span class="inline-block bg-black text-white text-xs px-2 py-1 rounded-full font-sans">Advanced</span>
                    {% endif %}

                    <!-- Intensive English badge -->
                    {% if school.intensive_english_centre == "Y" %}
                    <span class="inline-block bg-black text-white text-xs px-2 py-1 rounded-full font-sans">Intensive English</span>
                    {% endif %}
                </div>

                <a
                    href="/school/{{ school.id }}"
                    class="block w-full bg-black text-white text-center px-4 py-3 rounded-lg font-hand font-bold hover:bg-gray-800 transition-colors"
                >
                    View Details
                </a>
            </div>
            {% endfor %}
        </div>
    </form>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Comparison checkboxes - limit to 3
    const checkboxes = document.querySelectorAll('.compare-checkbox');
    const compareBtn = document.getElementById('compareBtn');
    const compareForm = document.getElementById('compareForm');

    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const checked = document.querySelectorAll('.compare-checkbox:checked');
            if (checked.length > 3) {
                this.checked = false;
                alert('You can only compare up to 3 schools');
                return;
            }
            compareBtn.disabled = checked.length === 0;
        });
    });

    compareForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const checked = document.querySelectorAll('.compare-checkbox:checked');
        if (checked.length === 0) {
            alert('Please select at least one school to compare');
            return;
        }
        const ids = Array.from(checked).map(cb => cb.value).join(',');
        const distances = Array.from(checked).map(cb => cb.dataset.distance).join(',');
        window.location.href = `/compare?ids=${ids}&distances=${distances}`;
    });

    // Save buttons
    function updateSaveButton(btn, isSaved) {
        const outlineHeart = btn.querySelector('.heart-outline');
        const filledHeart = btn.querySelector('.heart-filled');
        if (isSaved) {
            outlineHeart.classList.add('hidden');
            filledHeart.classList.remove('hidden');
            btn.classList.remove('text-gray-400');
            btn.classList.add('text-red-500');
        } else {
            outlineHeart.classList.remove('hidden');
            filledHeart.classList.add('hidden');
            btn.classList.add('text-gray-400');
            btn.classList.remove('text-red-500');
        }
    }

    document.querySelectorAll('.save-btn').forEach(btn => {
        const schoolId = parseInt(btn.dataset.schoolId);
        // Set initial state
        updateSaveButton(btn, SavedSchools.isSaved(schoolId));

        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const school = JSON.parse(this.dataset.school);
            if (SavedSchools.isSaved(school.id)) {
                SavedSchools.remove(school.id);
                updateSaveButton(this, false);
            } else {
                SavedSchools.save(school);
                updateSaveButton(this, true);
            }
        });
    });
});
</script>
{% endblock %}
